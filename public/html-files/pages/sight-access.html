<!-- ========================================== -->
<!-- SIGHT-ACCESS.HTML                         -->
<!-- Standalone accessibility tools box        -->
<!-- Fetch into any public page via:           -->
<!--   fetch('/html-files/pages/sight-access.html') -->
<!-- ========================================== -->
<!-- Icons from: https://raw.githubusercontent.com/gpaskids/icons-core/main/ -->
<!-- ========================================== -->

<style>
/* ========================================== */
/* SIGHT-ACCESS.HTML STYLES                   */
/* All styles scoped to this component        */
/* ========================================== */

/* ========== FLOATING ACCESSIBILITY BOX ========== */
/* Fixed position bottom-right corner             */
/* Semi-transparent orange with orange border     */
/* Contains: Go to Top, Break Timer, High Contrast */

.sight-access-box {
  position: fixed;
  bottom: 86px;
  right: 16px;
  background: rgba(249, 115, 22, 0.2);
  border: 2px solid #F97316;
  border-radius: 8px;
  padding: 8px;
  z-index: 50;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

/* ========== ACCESSIBILITY BUTTON STYLING ========== */
/* 3D appearance with shadows                        */
/* 70x70px size with 44px minimum touch target       */
/* Icons fill button maintaining aspect ratio        */

.sight-access-btn {
  width: 70px;
  height: 70px;
  border: 2px solid #D97706;
  border-radius: 8px;
  background: linear-gradient(180deg, #FED7AA 0%, #FDBA74 50%, #FB923C 100%);
  box-shadow: 
    0 4px 0 #C2410C,
    0 6px 8px rgba(0, 0, 0, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.4);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 4px;
  position: relative;
  transition: transform 0.1s ease, box-shadow 0.1s ease;
}

/* Button active/pressed state */
.sight-access-btn:active {
  transform: translateY(2px);
  box-shadow: 
    0 2px 0 #C2410C,
    0 3px 4px rgba(0, 0, 0, 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.4);
}

/* Button focus state for keyboard navigation */
.sight-access-btn:focus {
  outline: 3px solid #2563EB;
  outline-offset: 2px;
}

/* Icon inside button - fills container */
.sight-access-btn img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  border-radius: 4px;
}

/* ========== CSS-ONLY TOOLTIPS ========== */
/* Appear on hover, positioned to left    */
/* No JavaScript required                 */

.sight-access-btn::before {
  content: attr(data-tooltip);
  position: absolute;
  right: calc(100% + 8px);
  top: 50%;
  transform: translateY(-50%);
  background: #1F2937;
  color: white;
  padding: 6px 10px;
  border-radius: 4px;
  font-size: 14px;
  font-family: 'Lexend', sans-serif;
  white-space: nowrap;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s ease, visibility 0.2s ease;
  pointer-events: none;
  z-index: 100;
}

/* Tooltip arrow */
.sight-access-btn::after {
  content: '';
  position: absolute;
  right: calc(100% + 4px);
  top: 50%;
  transform: translateY(-50%);
  border: 6px solid transparent;
  border-left-color: #1F2937;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s ease, visibility 0.2s ease;
  pointer-events: none;
}

/* Show tooltip on hover */
.sight-access-btn:hover::before,
.sight-access-btn:hover::after {
  opacity: 1;
  visibility: visible;
}

/* ========== BREAK TIMER POPUP (SYS-BT2) ========== */
/* Draggable popup showing time until next break    */
/* Opens when user clicks Break Timer button        */
/* Forest green border, cream background            */

.break-timer-popup {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 288px;
  height: 520px;
  background: #FFFEF5;
  border: 4px solid #228B22;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  z-index: 1000;
  padding: 20px;
  font-family: 'Lexend', sans-serif;
}

/* Show state */
.break-timer-popup.visible {
  display: block;
}

/* Draggable header area */
.break-timer-header {
  cursor: move;
  user-select: none;
  margin-bottom: 16px;
}

/* Sparky icon floated left */
.break-timer-icon {
  float: left;
  width: 100px;
  height: 100px;
  margin-right: 12px;
  margin-bottom: 8px;
  border-radius: 8px;
}

/* Title text */
.break-timer-title {
  font-size: 22px;
  font-weight: 600;
  color: #1F2937;
  margin-bottom: 8px;
}

/* Large countdown display */
.break-timer-countdown {
  font-size: 48px;
  font-weight: 700;
  color: #228B22;
  text-align: center;
  margin: 20px 0;
  clear: both;
}

/* Minutes label */
.break-timer-label {
  font-size: 18px;
  font-weight: 500;
  color: #6B7280;
  text-align: center;
  margin-bottom: 20px;
}

/* Informational text */
.break-timer-info {
  font-size: 16px;
  color: #4B5563;
  line-height: 1.5;
  text-align: center;
  margin-bottom: 24px;
}

/* Close button container */
.break-timer-footer {
  position: absolute;
  bottom: 20px;
  left: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

/* System code label */
.system-code {
  position: absolute;
  bottom: 8px;
  right: 12px;
  font-size: 11px;
  color: #9CA3AF;
  font-family: monospace;
}

/* ========== BREAK REMINDER POPUP (SYS-BT3) ========== */
/* Auto-opens when 55-minute timer reaches zero        */
/* Forest green background, not draggable              */
/* Two modes: Countdown and Celebration                */

.break-reminder-popup {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 288px;
  min-height: 490px;
  background: linear-gradient(180deg, #2D5A2D 0%, #228B22 100%);
  border: 4px solid #1B6B1B;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  z-index: 1001;
  padding: 24px;
  font-family: 'Lexend', sans-serif;
  color: white;
}

/* Show state */
.break-reminder-popup.visible {
  display: block;
}

/* Title */
.break-reminder-title {
  font-size: 26px;
  font-weight: 700;
  text-align: center;
  margin-bottom: 16px;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

/* Countdown timer in reminder */
.break-reminder-countdown {
  font-size: 56px;
  font-weight: 800;
  text-align: center;
  margin: 16px 0;
  color: #FEF3C7;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
}

/* Minutes remaining label */
.break-reminder-sublabel {
  font-size: 16px;
  text-align: center;
  margin-bottom: 20px;
  opacity: 0.9;
}

/* Break ideas section */
.break-ideas {
  background: rgba(255, 255, 255, 0.15);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
}

.break-ideas-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 12px;
}

.break-ideas-list {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 15px;
  line-height: 1.8;
}

.break-ideas-list li {
  padding-left: 24px;
  position: relative;
  transition: font-weight 0.3s ease;
}

.break-ideas-list li::before {
  content: 'âœ“';
  position: absolute;
  left: 0;
  color: #FEF3C7;
}

/* Progressive bolding class */
.break-ideas-list li.emphasized {
  font-weight: 700;
}

/* ========== CELEBRATION MODE ========== */
/* Shown after break is complete         */

.celebration-content {
  display: none;
  text-align: center;
}

.celebration-content.visible {
  display: block;
}

.celebration-character {
  width: 150px;
  height: 150px;
  border-radius: 12px;
  margin: 0 auto 20px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  object-fit: contain;
  background: rgba(255, 255, 255, 0.1);
}

.celebration-message {
  font-size: 22px;
  font-weight: 600;
  margin-bottom: 8px;
}

.celebration-submessage {
  font-size: 16px;
  opacity: 0.9;
  margin-bottom: 24px;
}

/* ========== SHARED BUTTON STYLES ========== */
/* Orange 3D buttons for Close actions       */

.sight-close-btn {
  display: inline-block;
  min-width: 120px;
  padding: 12px 24px;
  font-size: 18px;
  font-weight: 600;
  font-family: 'Lexend', sans-serif;
  color: #1F2937;
  background: linear-gradient(180deg, #FED7AA 0%, #FDBA74 50%, #FB923C 100%);
  border: 2px solid #D97706;
  border-radius: 8px;
  box-shadow: 
    0 4px 0 #C2410C,
    0 6px 8px rgba(0, 0, 0, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.4);
  cursor: pointer;
  transition: transform 0.1s ease, box-shadow 0.1s ease;
}

.sight-close-btn:active {
  transform: translateY(2px);
  box-shadow: 
    0 2px 0 #C2410C,
    0 3px 4px rgba(0, 0, 0, 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.4);
}

.sight-close-btn:focus {
  outline: 3px solid #2563EB;
  outline-offset: 2px;
}

.sight-close-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* ========== TOAST NOTIFICATION ========== */
/* Brief message for break complete        */

.sight-toast {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: #228B22;
  color: white;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  font-family: 'Lexend', sans-serif;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
  opacity: 0;
  visibility: hidden;
  transition: transform 0.3s ease, opacity 0.3s ease, visibility 0.3s ease;
  z-index: 1100;
}

.sight-toast.visible {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
  visibility: visible;
}

/* ========== PRINT STYLES ========== */
/* Hide all accessibility tools when printing */

@media print {
  .sight-access-box,
  .break-timer-popup,
  .break-reminder-popup,
  .sight-toast {
    display: none !important;
  }
}

/* ========== HIGH CONTRAST MODE ========== */
/* Enhanced visibility when toggled        */

[data-high-contrast="true"] .sight-access-box {
  background: rgba(0, 0, 0, 0.9);
  border-color: #FFFFFF;
}

[data-high-contrast="true"] .sight-access-btn {
  background: #000000;
  border-color: #FFFFFF;
  box-shadow: 0 4px 0 #FFFFFF;
}

[data-high-contrast="true"] .break-timer-popup {
  background: #000000;
  border-color: #FFFFFF;
  color: #FFFFFF;
}

[data-high-contrast="true"] .break-timer-title,
[data-high-contrast="true"] .break-timer-countdown,
[data-high-contrast="true"] .break-timer-label,
[data-high-contrast="true"] .break-timer-info {
  color: #FFFFFF;
}

[data-high-contrast="true"] .break-reminder-popup {
  background: #000000;
  border-color: #FFFFFF;
}
</style>

<!-- ========== FLOATING ACCESSIBILITY BOX ========== -->
<!-- Three stacked buttons: Go to Top, Break Timer, High Contrast -->
<!-- Positioned fixed bottom-right, semi-transparent orange       -->

<div class="sight-access-box" role="toolbar" aria-label="Accessibility tools">
  
  <!-- Go to Top Button -->
  <!-- ico-pup.gif: Scrolls page to top smoothly -->
  <button 
    type="button"
    id="sight-btn-top" 
    class="sight-access-btn"
    data-tooltip="Go to Top"
    aria-label="Scroll to top of page"
  >
    <img 
      src="https://raw.githubusercontent.com/gpaskids/icons-core/main/ico-pup.gif" 
      alt="Go to top"
      loading="lazy"
    >
  </button>
  
  <!-- Break Timer Button -->
  <!-- ico-brk.gif: Opens Break Timer popup (SYS-BT2) -->
  <button 
    type="button"
    id="sight-btn-break" 
    class="sight-access-btn"
    data-tooltip="Break Timer"
    aria-label="Open break timer"
  >
    <img 
      src="https://raw.githubusercontent.com/gpaskids/icons-core/main/ico-brk.gif" 
      alt="Break timer"
      loading="lazy"
    >
  </button>
  
  <!-- High Contrast Toggle Button -->
  <!-- ico-hct.png: Toggles high contrast mode -->
  <button 
    type="button"
    id="sight-btn-contrast" 
    class="sight-access-btn"
    data-tooltip="High Contrast"
    aria-label="Toggle high contrast mode"
  >
    <img 
      src="https://raw.githubusercontent.com/gpaskids/icons-core/main/ico-hct.png" 
      alt="High contrast toggle"
      loading="lazy"
    >
  </button>
  
</div>

<!-- ========== BREAK TIMER POPUP (SYS-BT2) ========== -->
<!-- Draggable popup showing time until next break    -->
<!-- Opens when user clicks Break Timer button        -->
<!-- Contains: Sparky icon, countdown, close button   -->

<div 
  id="break-timer-popup" 
  class="break-timer-popup"
  role="dialog"
  aria-labelledby="break-timer-title"
  aria-modal="true"
>
  <!-- Draggable header with Sparky icon -->
  <div class="break-timer-header" id="break-timer-drag-handle">
    <img 
      src="https://raw.githubusercontent.com/gpaskids/icons-core/main/ico-sft.gif" 
      alt="Sparky the dog with timer"
      class="break-timer-icon"
    >
    <div class="break-timer-title" id="break-timer-title">
      Next Break In â€”
    </div>
  </div>
  
  <!-- Large countdown display -->
  <div class="break-timer-countdown" id="timer-countdown-display">
    55
  </div>
  <div class="break-timer-label">minutes</div>
  
  <!-- Informational text -->
  <div class="break-timer-info">
    Taking regular breaks helps keep your eyes healthy and your mind fresh!
  </div>
  
  <!-- Footer with close button -->
  <div class="break-timer-footer">
    <button 
      type="button"
      id="break-timer-close" 
      class="sight-close-btn"
      aria-label="Close break timer"
    >
      CLOSE
    </button>
  </div>
  
  <!-- System code identifier -->
  <span class="system-code">SYS-BT2</span>
</div>

<!-- ========== BREAK REMINDER POPUP (SYS-BT3) ========== -->
<!-- Auto-opens when 55-minute timer reaches zero        -->
<!-- Two modes: Countdown (5 min break) and Celebration  -->
<!-- Not draggable - requires user attention             -->

<div 
  id="break-reminder-popup" 
  class="break-reminder-popup"
  role="alertdialog"
  aria-labelledby="break-reminder-title"
  aria-describedby="break-reminder-desc"
  aria-modal="true"
>
  <!-- ===== COUNTDOWN MODE ===== -->
  <!-- Shows 5-minute timer with break ideas -->
  <div id="countdown-mode">
    <div class="break-reminder-title" id="break-reminder-title">
      ðŸŒŸ Time for a Break! ðŸŒŸ
    </div>
    
    <div class="break-reminder-countdown" id="reminder-countdown-display">
      5:00
    </div>
    <div class="break-reminder-sublabel">minutes of break time</div>
    
    <!-- Break ideas with progressive bolding -->
    <div class="break-ideas" id="break-reminder-desc">
      <div class="break-ideas-title">Ideas for a quick break:</div>
      <ul class="break-ideas-list" id="break-ideas-list">
        <li id="idea-1">Stand up and stretch</li>
        <li id="idea-2">Get a drink of water</li>
        <li id="idea-3">Look out a window</li>
        <li id="idea-4">Take 5 deep breaths</li>
        <li id="idea-5">Walk around the room</li>
      </ul>
    </div>
    
    <div style="text-align: center; margin-top: 16px;">
      <button 
        type="button"
        id="reminder-close-btn" 
        class="sight-close-btn"
        aria-label="Close break reminder and mark break complete"
      >
        CLOSE
      </button>
    </div>
  </div>
  
  <!-- ===== CELEBRATION MODE ===== -->
  <!-- Shows random character with congratulations -->
  <div id="celebration-mode" class="celebration-content">
    <div class="break-reminder-title">
      ðŸŽ‰ Great Job! ðŸŽ‰
    </div>
    
    <img 
      id="celebration-character-img"
      src=""
      alt=""
      class="celebration-character"
    >
    
    <div class="celebration-message" id="celebration-msg">
      <!-- Filled by JavaScript -->
    </div>
    
    <div class="celebration-submessage">
      Your break timer has been reset to 55 minutes.
    </div>
    
    <button 
      type="button"
      id="celebration-close-btn" 
      class="sight-close-btn"
      aria-label="Close celebration and continue"
    >
      CONTINUE
    </button>
  </div>
  
  <!-- System code identifier -->
  <span class="system-code" style="color: rgba(255,255,255,0.5);">SYS-BT3</span>
</div>

<!-- ========== TOAST NOTIFICATION ========== -->
<!-- Brief popup message for break complete   -->

<div id="sight-toast" class="sight-toast" role="status" aria-live="polite">
  Break complete! Timer reset.
</div>

<script>
/* ========================================== */
/* SIGHT-ACCESS.HTML JAVASCRIPT              */
/* All functionality for accessibility tools  */
/* ========================================== */

(function() {
  'use strict';
  
  /* ========== CONSTANTS ========== */
  /* Timer settings and storage keys */
  
  var BREAK_INTERVAL_MINUTES = 55;
  var BREAK_DURATION_MINUTES = 5;
  var OFF_SITE_GRACE_PERIOD_MS = 10 * 60 * 1000; // 10 minutes
  var STORAGE_KEY = 'gpaskids_break_timer';
  var LEADER_LOCK_KEY = 'gpaskids_break_timer_leader';
  var CONTRAST_STORAGE_KEY = 'gpaskids_high_contrast';
  
  /* ========== CELEBRATION CHARACTERS ========== */
  /* Random character shown after break complete  */
  
  var CELEBRATION_CHARACTERS = [
    {
      icon: 'https://raw.githubusercontent.com/gpaskids/icons-core/main/ico-bsp.png',
      name: 'Buddy',
      message: 'Buddy says great job taking a break!'
    },
    {
      icon: 'https://raw.githubusercontent.com/gpaskids/icons-core/main/ico-fos.png',
      name: 'Fluffy',
      message: 'Fluffy is so proud of you!'
    },
    {
      icon: 'https://raw.githubusercontent.com/gpaskids/icons-core/main/ico-max.jpg',
      name: 'Max',
      message: 'Max says way to go, superstar!'
    },
    {
      icon: 'https://raw.githubusercontent.com/gpaskids/icons-core/main/ico-sos.png',
      name: 'Sparky',
      message: 'Sparky loves break time too!'
    }
  ];
  
  /* ========== DOM ELEMENTS ========== */
  
  var btnTop = document.getElementById('sight-btn-top');
  var btnBreak = document.getElementById('sight-btn-break');
  var btnContrast = document.getElementById('sight-btn-contrast');
  
  var timerPopup = document.getElementById('break-timer-popup');
  var timerCountdownDisplay = document.getElementById('timer-countdown-display');
  var timerCloseBtn = document.getElementById('break-timer-close');
  var timerDragHandle = document.getElementById('break-timer-drag-handle');
  
  var reminderPopup = document.getElementById('break-reminder-popup');
  var reminderCountdownDisplay = document.getElementById('reminder-countdown-display');
  var reminderCloseBtn = document.getElementById('reminder-close-btn');
  var countdownMode = document.getElementById('countdown-mode');
  var celebrationMode = document.getElementById('celebration-mode');
  var celebrationImg = document.getElementById('celebration-character-img');
  var celebrationMsg = document.getElementById('celebration-msg');
  var celebrationCloseBtn = document.getElementById('celebration-close-btn');
  
  var breakIdeasList = document.getElementById('break-ideas-list');
  var toast = document.getElementById('sight-toast');
  
  /* ========== STATE VARIABLES ========== */
  
  var mainTimerInterval = null;
  var breakTimerInterval = null;
  var minutesRemaining = BREAK_INTERVAL_MINUTES;
  var breakSecondsRemaining = BREAK_DURATION_MINUTES * 60;
  var isBreakActive = false;
  var tabId = 'tab_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  var lastVisibilityTime = Date.now();
  var wasHidden = false;
  
  /* ========== GO TO TOP BUTTON ========== */
  /* Smooth scrolls page to top            */
  
  btnTop.addEventListener('click', function() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
  
  /* ========== HIGH CONTRAST TOGGLE ========== */
  /* Toggles data-high-contrast attribute      */
  /* Persists preference in localStorage       */
  
  // Load saved preference on init
  var savedContrast = localStorage.getItem(CONTRAST_STORAGE_KEY);
  if (savedContrast === 'true') {
    document.documentElement.setAttribute('data-high-contrast', 'true');
  }
  
  btnContrast.addEventListener('click', function() {
    var isHighContrast = document.documentElement.getAttribute('data-high-contrast') === 'true';
    var newValue = !isHighContrast;
    
    if (newValue) {
      document.documentElement.setAttribute('data-high-contrast', 'true');
    } else {
      document.documentElement.removeAttribute('data-high-contrast');
    }
    
    localStorage.setItem(CONTRAST_STORAGE_KEY, newValue.toString());
  });
  
  /* ========== BREAK TIMER BUTTON ========== */
  /* Opens the Break Timer popup (SYS-BT2)   */
  
  btnBreak.addEventListener('click', function() {
    openTimerPopup();
  });
  
  /* ========== TIMER POPUP FUNCTIONS ========== */
  
  function openTimerPopup() {
    timerPopup.classList.add('visible');
    updateTimerDisplay();
    // Focus close button for accessibility
    timerCloseBtn.focus();
  }
  
  function closeTimerPopup() {
    timerPopup.classList.remove('visible');
  }
  
  timerCloseBtn.addEventListener('click', closeTimerPopup);
  
  // Close on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      if (timerPopup.classList.contains('visible')) {
        closeTimerPopup();
      }
    }
  });
  
  /* ========== DRAGGABLE TIMER POPUP ========== */
  /* Mouse and touch event handlers             */
  /* Constrained to viewport bounds             */
  
  var isDragging = false;
  var dragOffsetX = 0;
  var dragOffsetY = 0;
  
  timerDragHandle.addEventListener('mousedown', startDrag);
  timerDragHandle.addEventListener('touchstart', startDrag, { passive: false });
  
  function startDrag(e) {
    isDragging = true;
    
    var clientX, clientY;
    if (e.type === 'touchstart') {
      e.preventDefault();
      clientX = e.touches[0].clientX;
      clientY = e.touches[0].clientY;
    } else {
      clientX = e.clientX;
      clientY = e.clientY;
    }
    
    var rect = timerPopup.getBoundingClientRect();
    dragOffsetX = clientX - rect.left;
    dragOffsetY = clientY - rect.top;
    
    // Remove transform to use top/left positioning
    timerPopup.style.transform = 'none';
    timerPopup.style.left = rect.left + 'px';
    timerPopup.style.top = rect.top + 'px';
    
    document.addEventListener('mousemove', onDrag);
    document.addEventListener('mouseup', stopDrag);
    document.addEventListener('touchmove', onDrag, { passive: false });
    document.addEventListener('touchend', stopDrag);
  }
  
  function onDrag(e) {
    if (!isDragging) return;
    
    var clientX, clientY;
    if (e.type === 'touchmove') {
      e.preventDefault();
      clientX = e.touches[0].clientX;
      clientY = e.touches[0].clientY;
    } else {
      clientX = e.clientX;
      clientY = e.clientY;
    }
    
    var newX = clientX - dragOffsetX;
    var newY = clientY - dragOffsetY;
    
    // Constrain to viewport
    var popupWidth = timerPopup.offsetWidth;
    var popupHeight = timerPopup.offsetHeight;
    var maxX = window.innerWidth - popupWidth;
    var maxY = window.innerHeight - popupHeight;
    
    newX = Math.max(0, Math.min(newX, maxX));
    newY = Math.max(0, Math.min(newY, maxY));
    
    timerPopup.style.left = newX + 'px';
    timerPopup.style.top = newY + 'px';
  }
  
  function stopDrag() {
    isDragging = false;
    document.removeEventListener('mousemove', onDrag);
    document.removeEventListener('mouseup', stopDrag);
    document.removeEventListener('touchmove', onDrag);
    document.removeEventListener('touchend', stopDrag);
  }
  
  /* ========== BREAK REMINDER FUNCTIONS ========== */
  /* Opens automatically when main timer hits 0    */
  
  function openBreakReminder() {
    isBreakActive = true;
    breakSecondsRemaining = BREAK_DURATION_MINUTES * 60;
    
    // Show countdown mode, hide celebration
    countdownMode.style.display = 'block';
    celebrationMode.classList.remove('visible');
    
    // Disable close button initially (3 seconds)
    reminderCloseBtn.disabled = true;
    setTimeout(function() {
      reminderCloseBtn.disabled = false;
    }, 3000);
    
    // Reset idea emphasis
    var ideas = breakIdeasList.querySelectorAll('li');
    ideas.forEach(function(li) {
      li.classList.remove('emphasized');
    });
    
    reminderPopup.classList.add('visible');
    startBreakCountdown();
    
    // Announce to screen readers
    var announcement = document.createElement('div');
    announcement.setAttribute('role', 'alert');
    announcement.setAttribute('aria-live', 'assertive');
    announcement.textContent = 'Time for a 5 minute break!';
    announcement.style.position = 'absolute';
    announcement.style.left = '-9999px';
    document.body.appendChild(announcement);
    setTimeout(function() {
      document.body.removeChild(announcement);
    }, 1000);
  }
  
  function closeBreakReminder() {
    reminderPopup.classList.remove('visible');
    stopBreakCountdown();
    
    if (isBreakActive) {
      // Break was cut short, still reset main timer
      onBreakComplete();
    }
  }
  
  function showCelebration() {
    isBreakActive = false;
    stopBreakCountdown();
    
    // Pick random character
    var character = CELEBRATION_CHARACTERS[Math.floor(Math.random() * CELEBRATION_CHARACTERS.length)];
    
    celebrationImg.src = character.icon;
    celebrationImg.alt = character.name;
    celebrationMsg.textContent = character.message;
    
    // Hide countdown, show celebration
    countdownMode.style.display = 'none';
    celebrationMode.classList.add('visible');
    
    // Show toast
    showToast('Break complete! Timer reset.');
    
    // Reset main timer
    resetMainTimer();
  }
  
  reminderCloseBtn.addEventListener('click', function() {
    if (isBreakActive) {
      // Closing during break - show celebration
      showCelebration();
    } else {
      closeBreakReminder();
    }
  });
  
  celebrationCloseBtn.addEventListener('click', function() {
    closeBreakReminder();
  });
  
  /* ========== BREAK COUNTDOWN TIMER ========== */
  /* 5-minute countdown with progressive emphasis */
  
  function startBreakCountdown() {
    updateBreakDisplay();
    
    breakTimerInterval = setInterval(function() {
      breakSecondsRemaining--;
      
      if (breakSecondsRemaining <= 0) {
        // Break complete!
        showCelebration();
      } else {
        updateBreakDisplay();
        updateIdeaEmphasis();
      }
    }, 1000);
  }
  
  function stopBreakCountdown() {
    if (breakTimerInterval) {
      clearInterval(breakTimerInterval);
      breakTimerInterval = null;
    }
  }
  
  function updateBreakDisplay() {
    var minutes = Math.floor(breakSecondsRemaining / 60);
    var seconds = breakSecondsRemaining % 60;
    reminderCountdownDisplay.textContent = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
  }
  
  function updateIdeaEmphasis() {
    // Progressive bolding: emphasize more items as time passes
    var totalSeconds = BREAK_DURATION_MINUTES * 60;
    var elapsed = totalSeconds - breakSecondsRemaining;
    var progress = elapsed / totalSeconds;
    
    // Emphasize items based on progress (20%, 40%, 60%, 80%, 100%)
    var ideas = breakIdeasList.querySelectorAll('li');
    var numToEmphasize = Math.floor(progress * 5);
    
    ideas.forEach(function(li, index) {
      if (index < numToEmphasize) {
        li.classList.add('emphasized');
      }
    });
  }
  
  /* ========== MAIN TIMER FUNCTIONS ========== */
  /* 55-minute countdown to next break         */
  
  function initMainTimer() {
    // Try to load saved state
    var saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      try {
        var state = JSON.parse(saved);
        var now = Date.now();
        var elapsed = now - state.lastUpdate;
        
        // Check if we've been away too long (grace period)
        if (elapsed > OFF_SITE_GRACE_PERIOD_MS) {
          // Reset timer
          minutesRemaining = BREAK_INTERVAL_MINUTES;
        } else {
          // Restore remaining time, accounting for elapsed
          var elapsedMinutes = Math.floor(elapsed / 60000);
          minutesRemaining = Math.max(0, state.minutesRemaining - elapsedMinutes);
        }
      } catch (e) {
        minutesRemaining = BREAK_INTERVAL_MINUTES;
      }
    }
    
    saveTimerState();
    startMainTimer();
  }
  
  function startMainTimer() {
    updateTimerDisplay();
    
    // Update every minute
    mainTimerInterval = setInterval(function() {
      minutesRemaining--;
      
      if (minutesRemaining <= 0) {
        // Time for a break!
        stopMainTimer();
        openBreakReminder();
      } else {
        updateTimerDisplay();
        saveTimerState();
      }
    }, 60000); // Every minute
  }
  
  function stopMainTimer() {
    if (mainTimerInterval) {
      clearInterval(mainTimerInterval);
      mainTimerInterval = null;
    }
  }
  
  function resetMainTimer() {
    minutesRemaining = BREAK_INTERVAL_MINUTES;
    saveTimerState();
    startMainTimer();
    updateTimerDisplay();
  }
  
  function updateTimerDisplay() {
    timerCountdownDisplay.textContent = minutesRemaining;
  }
  
  function saveTimerState() {
    var state = {
      minutesRemaining: minutesRemaining,
      lastUpdate: Date.now(),
      tabId: tabId
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }
  
  function onBreakComplete() {
    isBreakActive = false;
    resetMainTimer();
  }
  
  /* ========== VISIBILITY CHANGE HANDLER ========== */
  /* Track when user leaves/returns to site         */
  
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
      // User left - save state
      wasHidden = true;
      lastVisibilityTime = Date.now();
      saveTimerState();
    } else {
      // User returned
      if (wasHidden) {
        var elapsed = Date.now() - lastVisibilityTime;
        
        if (elapsed > OFF_SITE_GRACE_PERIOD_MS) {
          // Been away too long, reset timer
          minutesRemaining = BREAK_INTERVAL_MINUTES;
          updateTimerDisplay();
          saveTimerState();
        } else {
          // Account for time away
          var elapsedMinutes = Math.floor(elapsed / 60000);
          minutesRemaining = Math.max(0, minutesRemaining - elapsedMinutes);
          
          if (minutesRemaining <= 0) {
            stopMainTimer();
            openBreakReminder();
          } else {
            updateTimerDisplay();
            saveTimerState();
          }
        }
        
        wasHidden = false;
      }
    }
  });
  
  /* ========== STORAGE EVENT HANDLER ========== */
  /* Sync timer state across browser tabs       */
  
  window.addEventListener('storage', function(e) {
    if (e.key === STORAGE_KEY && e.newValue) {
      try {
        var state = JSON.parse(e.newValue);
        // Only sync if from a different tab
        if (state.tabId !== tabId) {
          minutesRemaining = state.minutesRemaining;
          updateTimerDisplay();
        }
      } catch (err) {
        // Ignore parse errors
      }
    }
  });
  
  /* ========== TOAST NOTIFICATION ========== */
  /* Brief popup message                     */
  
  function showToast(message) {
    toast.textContent = message;
    toast.classList.add('visible');
    
    setTimeout(function() {
      toast.classList.remove('visible');
    }, 3000);
  }
  
  /* ========== INITIALIZATION ========== */
  /* Start the main timer on load        */
  
  initMainTimer();
  
  console.log('[sight-access] Accessibility tools initialized');
  console.log('[sight-access] Break timer: ' + minutesRemaining + ' minutes until next break');
  
})();
</script>
